<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crash - STORM Casino</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .crash-display { font-size: 5rem; font-weight: 700; text-align: center; transition: all 0.1s; }
    .crash-display.rising { color: var(--accent-success); }
    .crash-display.crashed { color: var(--accent-danger); }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="nav-brand">
      <span class="logo">âš¡</span>
      <span class="brand-name">STORM</span>
    </a>
    <div class="nav-user">
      <div class="balance-display">
        <span class="balance-label">Balance</span>
        <span class="balance-amount" id="userBalance">$0.00</span>
      </div>
      <a href="/" class="btn btn-outline">Back</a>
    </div>
  </nav>

  <div class="game-layout">
    <div class="game-area">
      <div class="crash-display" id="crashDisplay">1.00x</div>
      <div id="gameStatus" style="text-align: center; margin-top: 1rem; color: var(--text-muted);">Set your cashout target and bet!</div>
    </div>

    <div class="game-controls">
      <h2 style="margin-bottom: 1.5rem;">Crash</h2>

      <div class="form-group">
        <label class="form-label">Bet Amount ($)</label>
        <input type="number" id="betAmount" class="form-input" value="1" min="0.01" step="0.01">
        <div class="bet-buttons" style="margin-top: 0.5rem;">
          <button class="btn btn-outline" onclick="multiplyBet(0.5)">1/2</button>
          <button class="btn btn-outline" onclick="multiplyBet(2)">2x</button>
          <button class="btn btn-outline" onclick="setMax()">Max</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Auto Cashout At</label>
        <input type="number" id="cashoutAt" class="form-input" value="2" min="1.01" max="100" step="0.01">
      </div>

      <div class="multiplier-display">
        <span style="color: var(--text-muted);">Potential Profit</span>
        <div class="multiplier-value" id="potentialProfit">$1.00</div>
      </div>

      <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="playCrash()" id="playBtn">Place Bet</button>

      <div id="lastResults" style="margin-top: 1.5rem;">
        <span style="color: var(--text-muted); font-size: 0.875rem;">Crash History:</span>
        <div id="resultHistory" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;"></div>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    let userBalance = 0;

    async function init() {
      const res = await fetch('/api/auth/me');
      if (!res.ok) {
        window.location.href = '/login.html';
        return;
      }
      const user = await res.json();
      userBalance = user.balance;
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      document.getElementById('userBalance').textContent = '$' + userBalance.toFixed(2);
    }

    function updatePotentialProfit() {
      const bet = parseFloat(document.getElementById('betAmount').value) || 0;
      const cashoutAt = parseFloat(document.getElementById('cashoutAt').value) || 2;
      const profit = (bet * cashoutAt - bet).toFixed(2);
      document.getElementById('potentialProfit').textContent = '$' + profit;
    }

    function multiplyBet(factor) {
      const input = document.getElementById('betAmount');
      input.value = Math.max(0.01, (parseFloat(input.value) * factor)).toFixed(2);
      updatePotentialProfit();
    }

    function setMax() {
      document.getElementById('betAmount').value = userBalance.toFixed(2);
      updatePotentialProfit();
    }

    async function playCrash() {
      const bet = parseFloat(document.getElementById('betAmount').value);
      const cashoutAt = parseFloat(document.getElementById('cashoutAt').value);

      if (bet > userBalance) {
        alert('Insufficient balance');
        return;
      }

      if (cashoutAt < 1.01 || cashoutAt > 100) {
        alert('Cashout must be between 1.01x and 100x');
        return;
      }

      document.getElementById('playBtn').disabled = true;
      const display = document.getElementById('crashDisplay');
      const status = document.getElementById('gameStatus');

      display.textContent = '1.00x';
      display.className = 'crash-display rising';
      status.textContent = 'Launching...';

      try {
        const res = await fetch('/api/game/crash', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bet, cashoutAt })
        });

        const data = await res.json();

        if (res.ok) {
          await animateCrash(data.crashPoint, cashoutAt, data.win);
          
          userBalance = data.newBalance;
          updateBalanceDisplay();

          if (data.win) {
            status.textContent = `Cashed out at ${cashoutAt}x! +$${data.payout.toFixed(2)}`;
            status.style.color = 'var(--accent-success)';
          } else {
            status.textContent = `Crashed at ${data.crashPoint}x! -$${bet.toFixed(2)}`;
            status.style.color = 'var(--accent-danger)';
          }

          addToHistory(data.crashPoint);
        } else {
          alert(data.error);
        }
      } catch (e) {
        alert('Game error');
      }

      document.getElementById('playBtn').disabled = false;
    }

    function animateCrash(crashPoint, cashoutAt, won) {
      return new Promise(resolve => {
        const display = document.getElementById('crashDisplay');
        let current = 1.0;
        const target = won ? cashoutAt : crashPoint;
        const increment = (target - 1) / 30;

        const animate = setInterval(() => {
          current += increment;
          if (current >= target) {
            current = target;
            clearInterval(animate);
            
            display.textContent = current.toFixed(2) + 'x';
            if (!won) {
              display.className = 'crash-display crashed';
            }
            resolve();
          } else {
            display.textContent = current.toFixed(2) + 'x';
          }
        }, 50);
      });
    }

    function addToHistory(crashPoint) {
      const history = document.getElementById('resultHistory');
      const badge = document.createElement('span');
      badge.className = 'status-badge ' + (crashPoint >= 2 ? 'status-confirmed' : 'status-rejected');
      badge.textContent = crashPoint.toFixed(2) + 'x';
      history.prepend(badge);
      if (history.children.length > 10) {
        history.removeChild(history.lastChild);
      }
    }

    document.getElementById('betAmount').addEventListener('input', updatePotentialProfit);
    document.getElementById('cashoutAt').addEventListener('input', updatePotentialProfit);
    
    updatePotentialProfit();
    init();
  </script>
</body>
</html>
